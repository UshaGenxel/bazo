document.addEventListener("DOMContentLoaded",function(){if(window.bazoProfileFormData&&window.bazoProfileFormData.woocommerceActive){const n=document.getElementById("country-select"),i=document.getElementById("state-select");function e(e,s=""){if(!e||!window.bazoProfileFormData.states[e])return void(i.innerHTML='<option value="" disabled>Select country first</option>');const t=window.bazoProfileFormData.states[e];let r='<option value="" disabled>Select state</option>';for(const[e,a]of Object.entries(t))r+=`<option value="${e}" ${s===e?"selected":""}>${a}</option>`;i.innerHTML=r}n&&i&&(n.addEventListener("change",function(){e(this.value)}),n.value&&e(n.value,window.bazoProfileFormData.savedState))}const s=document.getElementById("profile-image-upload");s&&s.addEventListener("change",function(e){const s=e.target.files[0];if(!s)return;if(!s.type.startsWith("image/"))return void o("Please select a valid image file","error");if(s.size>5242880)return void o("Image file size must be less than 5MB","error");const t=document.getElementById("profile-image-preview"),r=new FileReader;r.onload=function(e){t.src=e.target.result,t.dataset.hasNewImage="true"},r.readAsDataURL(s)});const t=document.getElementById("bazo-profile-form");if(t){const l=t.querySelector('[name="first_name"]'),c=t.querySelector('[name="last_name"]'),d=t.querySelector('[name="user_email"]'),u=t.querySelector('[name="password"]'),m=t.querySelector('[name="password_confirm"]');l&&(l.addEventListener("blur",function(){this.value.trim()?a("first_name","","success"):a("first_name","First name is required","error")}),l.addEventListener("input",function(){this.value.trim()&&a("first_name","","success")})),c&&(c.addEventListener("blur",function(){this.value.trim()?a("last_name","","success"):a("last_name","Last name is required","error")}),c.addEventListener("input",function(){this.value.trim()&&a("last_name","","success")})),d&&(d.addEventListener("blur",function(){const e=this.value.trim();e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?a("user_email","","success"):a("user_email","Please enter a valid email address","error"):a("user_email","Email is required","error")}),d.addEventListener("input",function(){const e=this.value.trim();e&&/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)&&a("user_email","","success")})),u&&m&&(u.addEventListener("input",function(){const e=this.value,s=m.value;e&&e.length>=6?s&&e===s?a("password","Passwords match","success"):s?a("password","Passwords do not match","error"):a("password","","success"):e&&e.length<6?a("password","Password must be at least 6 characters long","error"):a("password","","")}),m.addEventListener("input",function(){const e=u.value,s=this.value;e&&s?e.length<6?a("password","Password must be at least 6 characters long","error"):e===s?a("password","Passwords match","success"):a("password","Passwords do not match","error"):a("password","","")}),m.addEventListener("blur",function(){const e=u.value,s=this.value;e||s?e&&s?e!==s?a("password","Passwords do not match","error"):e.length<6?a("password","Password must be at least 6 characters long","error"):a("password","Passwords match","success"):e&&e.length<6?a("password","Password must be at least 6 characters long","error"):a("password","",""):a("password","","")})),t.addEventListener("submit",async function(e){e.preventDefault();const s=this.querySelector(".submit-button"),t=s.querySelector(".button-text"),n=s.querySelector(".spinner"),i=this.querySelector(".form-message-global");i.textContent="",i.className="form-message-global",this.querySelectorAll('[class^="form-message-"]').forEach(e=>{e.textContent="",e.className=e.className.replace(/\s+(success|error)/g,"")}),function(){const e=document.querySelector(".form-message-profile-image");e&&(e.textContent="",e.className="form-message-profile-image")}(),s.disabled=!0,t.textContent="Updating...",n.style.display="inline-block";try{if(!this.querySelector('[name="first_name"]').value.trim())return void a("first_name","First name is required","error");if(!this.querySelector('[name="last_name"]').value.trim())return void a("last_name","Last name is required","error");const e=this.querySelector('[name="user_email"]').value;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return void a("user_email","Please enter a valid email address","error");const s=this.querySelector('[name="password"]').value,t=this.querySelector('[name="password_confirm"]').value;if(s||t){if(s&&s.length<6)return void a("password","Password must be at least 6 characters long","error");if(s&&t&&s!==t)return void a("password","Passwords do not match","error")}const n=new FormData(this);n.append("action","bazo_profile_update"),n.append("security",window.bazoProfileFormData.nonce);const i=document.getElementById("profile-image-upload");i&&i.files[0]&&n.append("profile_image",i.files[0]);const l=await fetch(window.bazoProfileFormData.ajaxUrl,{method:"POST",body:n});if(!l.ok)throw new Error("Network error");const c=await l.json();if(c.success){if(r(c.data.message||"Profile updated successfully!","success"),c.data&&c.data.image_url){const e=document.getElementById("profile-image-preview");e&&(e.src=c.data.image_url)}setTimeout(()=>window.location.reload(),1500)}else{const e=[];if(!Array.isArray(c.data))throw new Error(c.data||"Failed to update profile");c.data.forEach(s=>{s.includes("First name")?a("first_name",s,"error"):s.includes("Last name")?a("last_name",s,"error"):s.includes("email")?a("user_email",s,"error"):s.includes("Password")?a("password",s,"error"):s.includes("Phone")?a("billing_phone",s,"error"):s.includes("file")||s.includes("image")||s.includes("Image")||s.includes("size")?o(s,"error"):e.includes(s)||e.push(s)}),e.length>0&&r(e.join("\n"),"error")}}catch(e){console.error("Profile update error:",e),r("An unexpected error occurred. Please try again.","error")}finally{s.disabled=!1,t.textContent="Update Profile",n.style.display="none"}})}function r(e,s="success"){const t=document.querySelector(".form-message-global");t&&(t.textContent=e,t.className=`form-message-global ${s}`)}function a(e,s,t="error"){const r=document.querySelector(`.form-message-${e}`),a=document.querySelector(`[name="${e}"]`);r&&(r.textContent=s,r.className=`form-message-${e}`,s&&t&&r.classList.add(t)),a&&(a.classList.remove("error","success"),s&&t&&a.classList.add(t))}function o(e,s="success"){const t=document.querySelector(".form-message-profile-image");t&&(t.textContent=e,t.className=`form-message-profile-image ${s}`)}});